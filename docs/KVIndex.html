<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KVIndex Interactive Documentation</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    #loader {
      display: none;
      color: #000;
      background: #fff;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      padding: 10px;
      border: 1px solid #ddd;
    }
    .code-container {
      position: relative;
    }
    .run-button {
      position: absolute;
      top: 0;
      right: 0;
    }
  </style>
</head>

<body>

<div class="container my-4">
  <div id="loader">Loading Python...</div>

  <h2>KVIndex Interactive Documentation</h2>

  <!-- Initialize KVIndex -->
  <h4 id="init" class="mt-4">Initialize KVIndex</h4>

  <div class="code-container">
    <textarea class="form-control" rows="2">from liteindex import KVIndex
kv_index = KVIndex("kv.db")</textarea>
    <button class="btn btn-primary run-button">Run</button>
    <div class="output-container"></div>
  </div>

  <!-- Set value in KVIndex -->
  <h4 id="setvalue" class="mt-4">Set a value</h4>
  <div class="code-container">
    <textarea class="form-control" rows="3">kv_index['example_key'] = 'example_value'</textarea>
    <button class="btn btn-primary run-button">Run</button>
    <div class="output-container"></div>
  </div>

  <!-- Get value from KVIndex -->
  <h4 id="getvalue" class="mt-4">Get a value</h4>
  <div class="code-container">
    <textarea class="form-control" rows="3">value = kv_index['example_key']
print(value)</textarea>
    <button class="btn btn-primary run-button">Run</button>
    <div class="output-container"></div>
  </div>

</div>

<script type="text/javascript">
    document.getElementById("loader").style.display = "block";
  
    async function main() {
      window.pyodide = await loadPyodide();
      await pyodide.loadPackage('micropip');
      document.getElementById("loader").innerHTML = "Preparing environment...";
      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install('sqlite3')
        await micropip.install('liteindex')
      `);
      document.getElementById("loader").style.display = "none";
      initializeRunButtons();
    }
  
    function initializeRunButtons() {
      document.querySelectorAll('.run-button').forEach(button => {
        button.addEventListener('click', async (event) => {
          let codeBlock = event.target.previousElementSibling; // The textarea.
          let outputContainer = event.target.nextElementSibling; // The output container.
  
          // Set up capturing of stdout.
          pyodide.runPython(`
            import sys
            import io
            class StringWriter(io.StringIO):
                def __init__(self):
                    super().__init__()
                    self.output = ''
                def write(self, s):
                    super().write(s)
                    self.output += s
            sys.stdout = StringWriter()
          `);
  
          try {
            await window.pyodide.runPythonAsync(codeBlock.value);
            // Fetch the captured stdout output.
            let output = pyodide.runPython('sys.stdout.getvalue()');
            outputContainer.textContent = `Output: ${output}`;
            outputContainer.style.whiteSpace = 'pre-wrap'; // Preserves formatting for multi-line output.
          } catch (error) {
            console.error(error);
            outputContainer.textContent = `Error: ${error}`;
            outputContainer.style.color = 'red';
          }
          
          // Restore the original stdout after execution.
          pyodide.runPython('sys.stdout = sys.__stdout__');
        });
      });
    }
  
    main();
  </script>

</body>
</html>